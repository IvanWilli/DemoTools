
# TODO 
# This is a high priority
# -[ ] make sure mig_resid_cohort() handles dimensions properly (named indexing; no waste dims)
# -[ ] make sure mig_resid_time() handles dimensions properly
# -[ ] check dims of incoming arguments.
# -[ ] new args years_pop, years_asfr, years_sr, years_srb (to be fed to checker)
# -[ ] write a dimension checker + trimming mig_resid_dim_check()
# -[ ] make this checker/trimmer the first step in mig_resid*()

# This can come next
# -[ ] make new package data. usethis::use_data(pop_m_mat)
# -[ ] document new package data in data.R following other examples

# Then this
# -[ ] write wrapper function, mig_resid() with an argumet 'method' 
#      with options "cohort", "stock" or "time", and all other args the same.

# Then this
# -[ ] unit tests

# Then this
# -[ ] sanity checks: do estimated migration patterns actually look reasonable in 
#      periods/places that are known to be strong in or out migration places.



#' Estimate net migration using residual methods: stock change,
#' time even flow and cohort even flow
#'
#' @details
#'
#' 1. The stock method (\code{mig_resid_stock}) is the difference in stocks that
#' survive between t and t+5, and the first age group is based on the difference
#' with the surviving births by sex.  It provides net migrants by lexis cohort
#' parallelograms, and basically such info gets used as end-period migration
#' since the migrants don't get exposed to mortality within the period.
#'
#' 2. The time even flow (\code{mig_resid_time}) method uses the result from
#' the first option, but splits it back into lexis period squares and assumes
#' that half of the net migrants get exposed to the mortality risk during this
#' period. Such info can get used as evenly distributed migration by period,
#' but the assumptions lead to zig-zag age patterns that are highly implausible.
#'
#' 3. The cohort even flow (\code{mig_resid_cohort}) method provides the most
#' meaningful pattern of net migration by age consistent by cohort and assumes
#' an evenly distribution within the 5-year period, and half of the migrants
#' get exposed both fertility and mortality within this period.
#'
#' @param pop_m_mat A \code{numeric} matrix with population counts. Rows should
#' be ages and columns should be years. Only five year age groups are supported.
#' See examples.
#'
#' @param pop_f_mat A \code{numeric} matrix with population counts. Rows should
#' be ages and columns should be years. Only five year age groups are supported.
#' See examples.
#'
#' @param sr_m_mat A \code{numeric} matrix with survival rates for males. Rows
#' should be ages and columns should be years. ** This matrix should have
#' one column less than \code{pop_m_mat} and \code{pop_f_mat}. For example,
#' if the last year in these matrices is 2050, then the last year in
#' \code{sr_m_mat} should be 2045. **
#'
#' @param sr_f_mat A \code{numeric} matrix with survival rates for females. Rows
#' should be ages and columns should be years. ** This matrix should have
#' one column less than \code{pop_m_mat} and \code{pop_f_mat}. For example,
#' if the last year in these matrices is 2050, then the last year in
#' \code{sr_f_mat} should be 2045. **.
#'
#' @param asfr_mat A \code{numeric} matrix with age specific fertility rates.
#' Rows should be ages and columns should be years. ** This matrix should have
#' one column less than \code{pop_m_mat} and \code{pop_f_mat}. For example,
#' if the last year in these matrices is 2050, then the last year in
#' \code{asfr_mat} should be 2045**. This row will usually have fewer age groups
#' (rows) than in the population matrices or survival matrices, so the user
#' needs to supply the specific ages in the \code{ages_fertility} argument.
#'
#' @param srb_vec A \code{numeric} vector of sex ratios at birth for every year.
#' The years should be the same as the years in \code{sr_m_mat},
#' \code{sr_f_mat}, and \code{asfr_mat}.
#'
#' @param ages A \code{numeric} vector of ages used in the rows in
#' \code{pop_m_mat}, \code{pop_f_mat}, \code{sr_m_mat}, \code{sr_f_mat}.
#'
#' @param ages_fertility A \code{numeric} vector of ages used in the rows in
#' \code{asfr_mat}.
#'
#' @return A list with two matrices. One is for males (called `mig_m`) and the
#' other for females (called `mig_f`). Both matrices contain net migration
#' estimates by age/period using one of the three methods.
#'
#' @examples
#'
#' ################ Stock change method #####################
#'
#' # Vector of population for males
#' pop_m <-
#'   c(835, 671, 570.999, 544, 552, 550, 513, 487.998, 432.002,
#'     378.001, 338.001, 295.999, 263.001, 220.999, 156, 92.001, 42.204,
#'     18.001, 4.331, 0.639, 0.07, 989.592, 880.029, 697.435, 575.575,
#'     561.146, 595.087, 582.08, 544.567, 507.247, 440.909, 373.935,
#'     316.617, 265.548, 235.035, 182.951, 110.75, 57.555, 18.737, 5.459,
#'     0.807, 0.065, 1133.424, 1037.502, 905.664, 698.771, 586.798,
#'     616.9, 638.007, 615.889, 550.076, 504.215, 430.131, 353.696,
#'     286.403, 238.634, 194.496, 130.76, 69.399, 26.238, 5.809, 1.011,
#'     0.083, 1149.519, 1149.942, 1042.707, 897.087, 691.317, 605.519,
#'     628.132, 641.442, 608.262, 532.131, 486.313, 401.381, 321.04,
#'     251.388, 197.567, 138.127, 81.716, 32.255, 8.386, 1.152, 0.112,
#'     959.81, 1167.439, 1166.318, 1054.263, 929.596, 770.233, 655.408,
#'     649.175, 641.542, 602.148, 513.273, 463.968, 371.397, 286.345,
#'     203.426, 141.486, 87.742, 38.904, 10.533, 1.647, 0.131, 904.577,
#'     990.842, 1195.275, 1192.299, 1096.101, 1010.808, 817.203, 673.368,
#'     657.377, 631.756, 591.218, 483.434, 432.18, 330.595, 237.691,
#'     147.718, 86.849, 42.396, 13.172, 2.217, 0.2, 914.965, 926.002,
#'     1008.784, 1224.923, 1217.653, 1099.911, 1019.023, 813.755, 676.39,
#'     643.237, 614.691, 562.266, 449.355, 383.548, 273.038, 176.289,
#'     92.764, 43.563, 15.48, 3.067, 0.316, 943.289, 927.824, 937.572,
#'     1036.631, 1265.185, 1225.442, 1108.122, 1014.48, 806.487, 659.135,
#'     627.186, 594.356, 527.096, 404.537, 320.095, 205.116, 112.331,
#'     47.821, 16.391, 3.791, 0.466, 982.718, 980.995, 958.024, 988.65,
#'     1076.907, 1293.734, 1267.032, 1135.973, 1031.081, 804.56, 654.945,
#'     615.926, 567.992, 487.466, 348.485, 248.7, 133.025, 58.273, 17.722,
#'     3.888, 0.553, 1012.228, 1014.939, 1019.3, 1013.749, 1016.987,
#'     1100.959, 1315.154, 1281.21, 1143.215, 1026.976, 788.317, 641.579,
#'     592.945, 521.839, 418.599, 270.316, 163.215, 70.003, 21.874,
#'     4.186, 0.549, 914.063, 1038.649, 1049.297, 1073.621, 1055.672,
#'     1047.487, 1138.313, 1344.753, 1295.431, 1144.702, 1016.992, 771.165,
#'     615.065, 550.259, 457.748, 334.624, 185.735, 87.221, 26.085,
#'     4.898, 0.538, 879.05, 952.912, 1081.565, 1116.92, 1130.826, 1092.34,
#'     1097.179, 1186.645, 1381.02, 1305.446, 1143.75, 989.552, 751.696,
#'     577.344, 489.506, 377.661, 245.003, 105.627, 34.645, 6.138, 0.619,
#'     967.471, 930.238, 993.227, 1141.416, 1220.943, 1218.465, 1152.732,
#'     1154.005, 1219.105, 1404.229, 1303.056, 1126.891, 960.563, 712.717,
#'     522.094, 415.611, 295.598, 149.226, 44.788, 8.64, 0.793, 996.168,
#'     1002.283, 955.049, 1097.332, 1284.199, 1236.929, 1269.189, 1192.192,
#'     1174.32, 1216.076, 1400.008, 1311.348, 1099.315, 941.078, 652.11,
#'     452.242, 319.415, 186.665, 65.652, 11.458, 1.11, 1020.925, 1011.765,
#'     1014.23, 1017.281, 1208.233, 1389.541, 1315.956, 1321.892, 1224.232,
#'     1189.671, 1215.983, 1380.774, 1275.239, 1047.397, 867.426, 568.286,
#'     355.943, 205.33, 83.6, 17, 1.474, 1028.191, 1035.869, 1023.388,
#'     1074.814, 1125.935, 1311.078, 1465.662, 1367.022, 1352.787, 1239.604,
#'     1191.356, 1203.245, 1346.713, 1220.838, 973.366, 765.273, 455.163,
#'     235.912, 97.148, 22.528, 2.061, 1035.917, 1043.755, 1047.947,
#'     1086.086, 1187.203, 1232.794, 1390.453, 1518.531, 1399.596, 1369.011,
#'     1242.733, 1181.749, 1178.339, 1295.414, 1142.767, 869.016, 624.221,
#'     310.175, 115.614, 27.037, 2.784, 1045.967, 1052.236, 1056.4,
#'     1113.398, 1203.477, 1298.811, 1316.2, 1446.37, 1552.621, 1417.392,
#'     1372.669, 1234.502, 1160.392, 1138.346, 1219.39, 1029.28, 718.949,
#'     434.576, 156.257, 33.016, 3.417, 1068.682, 1062.337, 1064.906,
#'     1121.9, 1230.868, 1315.242, 1382.275, 1372.643, 1481.225, 1570.215,
#'     1421.698, 1364.113, 1214.291, 1124.645, 1077.332, 1107.059, 862.313,
#'     510.375, 224.598, 45.72, 4.224, 1102.822, 1085.121, 1075.057,
#'     1130.572, 1239.683, 1342.955, 1399.057, 1438.921, 1408.243, 1499.967,
#'     1574.252, 1414.059, 1343.384, 1179.959, 1069.144, 985.391, 938.14,
#'     623.089, 270.065, 67.236, 5.855, 1140.8, 1119.328, 1097.897,
#'     1140.924, 1248.743, 1352.213, 1427.121, 1456.061, 1474.768, 1428.008,
#'     1505.633, 1566.169, 1394.527, 1308.152, 1126.043, 984.266, 844,
#'     689.026, 337.068, 82.618, 8.662)
#'
#' # Vector of population for females
#' pop_f <-
#'   c(801, 645, 554.001, 534, 557.999, 564, 521.001, 478.001,
#'     410.999, 352.999, 318, 276, 239, 196.998, 147, 92, 49.354, 23.001,
#'     6.5, 1.164, 0.135, 948.057, 844.618, 670.281, 562.978, 556.695,
#'     589.153, 595.677, 545.622, 488.336, 410.687, 346.698, 303.994,
#'     257.339, 222.218, 177.703, 111.516, 66.076, 25.155, 8.267, 1.423,
#'     0.145, 1082.85, 993.185, 866.81, 675.391, 590.032, 594.559, 626.777,
#'     624.823, 547.167, 485.337, 406.556, 337.02, 285.388, 243.185,
#'     202.252, 135.464, 80.488, 34.773, 9.379, 1.88, 0.182, 1091.999,
#'     1101.593, 998.637, 870.126, 696.038, 607.414, 608.372, 634.123,
#'     618.287, 534.182, 476.099, 390.902, 323.659, 270.819, 222.629,
#'     158.211, 99.985, 43.526, 13.425, 2.209, 0.243, 916.285, 1113.846,
#'     1116.448, 1022.769, 918.839, 752.674, 635.897, 619.411, 627.163,
#'     613.115, 524.316, 470.068, 384.21, 315.25, 247.486, 184.146,
#'     119.509, 56.879, 17.577, 3.347, 0.307, 858.616, 944.546, 1141.242,
#'     1148.666, 1080.544, 977.493, 784.947, 647.137, 627.282, 623.897,
#'     615.885, 510.514, 460.492, 370.614, 286.566, 207.64, 136.385,
#'     70.415, 24.027, 4.599, 0.483, 868.926, 877.749, 959.791, 1175.057,
#'     1195.136, 1093.776, 991.924, 782.722, 651.731, 622.015, 618.687,
#'     605.778, 500.641, 442.912, 341.607, 245.476, 158.844, 84.752,
#'     32.378, 7.171, 0.792, 895.173, 880.805, 893.824, 982.635, 1215.112,
#'     1205.436, 1108.77, 989.171, 783.703, 645.936, 620.163, 616.473,
#'     594.188, 483.99, 407.959, 294.664, 188.001, 102.344, 41.293,
#'     10.454, 1.36, 936.591, 930.873, 909.761, 937.09, 1040.314, 1261.087,
#'     1253.31, 1138.156, 1013.326, 789.43, 647.395, 618.625, 607.737,
#'     578.414, 450.459, 356.927, 227.408, 122.534, 50.048, 13.221,
#'     1.968, 962.734, 966.476, 967.107, 957.99, 982.293, 1078.452,
#'     1289.82, 1276.239, 1152.444, 1021.414, 790.697, 651.846, 612.561,
#'     584.997, 533.268, 389.96, 277.225, 150.795, 61.026, 16.175, 2.495,
#'     872.149, 989.229, 998.47, 1014.575, 1007.4, 1019.803, 1118.597,
#'     1322.793, 1295.408, 1160.933, 1017.656, 782.288, 640.445, 591.004,
#'     544.271, 468.132, 312.504, 184.648, 74.05, 18.888, 2.818, 831.614,
#'     907.289, 1032.916, 1054.491, 1087.81, 1064.803, 1079.765, 1163.223,
#'     1358.369, 1304.687, 1162.716, 1010.927, 777.628, 621.991, 554.866,
#'     485.032, 385.873, 214.234, 93.771, 23.583, 3.281, 918.838, 876.318,
#'     944.356, 1087.72, 1156.023, 1189.243, 1155.079, 1142.97, 1200.737,
#'     1385.864, 1307.092, 1157.85, 1000.01, 756.228, 585.003, 501.751,
#'     414.881, 275.154, 114.55, 31.799, 4.292, 950.252, 955.845, 901.601,
#'     1034.682, 1232.517, 1230.147, 1278.363, 1207.768, 1177.793, 1204.356,
#'     1388.633, 1309.444, 1137.271, 975.544, 718.972, 536.404, 423.543,
#'     303.137, 151.219, 39.364, 5.675, 972.207, 966.024, 968.771, 971.038,
#'     1155.236, 1343.606, 1310.409, 1330.404, 1239.077, 1193.687, 1207.497,
#'     1378.179, 1287.326, 1102.782, 925.427, 657.537, 458.654, 313.372,
#'     169.081, 52.593, 7.072, 976.405, 987.332, 978.581, 1036.217,
#'     1088.349, 1263.153, 1421.22, 1360.854, 1360.488, 1254.47, 1197.429,
#'     1200.365, 1355.979, 1250.443, 1049.613, 850.295, 565.065, 343.486,
#'     179.947, 59.846, 9.474, 983.61, 992.108, 1000.337, 1048.292,
#'     1157.406, 1200.03, 1343.652, 1473.399, 1392.3, 1376.507, 1258.974,
#'     1191.956, 1183.853, 1320.389, 1194.661, 970.4, 737.82, 429.619,
#'     201.231, 64.936, 11.111, 993.232, 1000.063, 1005.704, 1073.068,
#'     1174.732, 1273.909, 1284.275, 1398.562, 1506.421, 1409.749, 1381.642,
#'     1254.544, 1177.896, 1156.569, 1266.895, 1112.005, 851.243, 570.482,
#'     257.474, 74.251, 12.326, 1014.748, 1009.727, 1013.685, 1078.453,
#'     1199.539, 1291.299, 1358.178, 1339.471, 1432.104, 1523.907, 1415.474,
#'     1377.117, 1241.194, 1153.335, 1113.937, 1185.875, 984.267, 667.614,
#'     348.639, 96.877, 14.172, 1047.114, 1031.299, 1023.389, 1086.588,
#'     1205.189, 1316.366, 1375.813, 1413.531, 1373.503, 1450.422, 1529.735,
#'     1411.833, 1363.681, 1217.645, 1114.502, 1048.481, 1058.718, 782.58,
#'     415.883, 133.756, 18.362, 1083.119, 1063.736, 1045.012, 1096.489,
#'     1213.687, 1322.39, 1401.18, 1431.462, 1447.757, 1392.552, 1457.502,
#'     1526.287, 1399.672, 1340.065, 1180.192, 1054.342, 943.985, 853.051,
#'     496.821, 162.711, 25.414) / 1000
#'
#' # Vector of age-specific fertility rates
#' asfr <- c(50.369, 202.131, 206.141, 149.211, 87.253, 31.052,
#'           2.843, 57.919, 226.709, 222.516, 148.992, 87.888, 29.736, 2.64,
#'           54.096, 223.587, 211.46, 140.311, 76.881, 26.533, 2.132, 45.049,
#'           159.679, 156.131, 93.96, 50.059, 15.713, 1.409, 37.188, 119.39,
#'           132.748, 70.029, 28.02, 7.311, 0.514, 30.209, 101.658, 125.692,
#'           65.483, 19.804, 3.711, 0.243, 24.9, 88.815, 121.231, 68.621,
#'           20.031, 3.039, 0.163, 23.238, 78.247, 118.743, 75.403, 24.014,
#'           3.426, 0.129, 25.141, 75.764, 118.592, 85.555, 29.309, 4.303,
#'           0.136, 20.117, 64.41, 104.081, 85.589, 32.737, 5.247, 0.219,
#'           14.645, 53.484, 98.176, 92.658, 37.567, 6.397, 0.273, 13.677,
#'           51.37, 100.418, 104.868, 48.196, 8.278, 0.393, 11.494, 43.287,
#'           93.809, 106.904, 53.5, 10.662, 0.544, 8.387, 37.053, 86.307,
#'           106.038, 55.169, 11.345, 0.701, 6.625, 31.576, 80.064, 106.128,
#'           58.423, 13.087, 0.917, 5.468, 27.869, 76.196, 107.843, 62.296,
#'           15.036, 1.172, 4.686, 25.34, 73.943, 110.575, 66.487, 17.107,
#'           1.462, 4.134, 23.539, 72.551, 113.398, 70.423, 19.099, 1.756,
#'           3.732, 22.206, 71.53, 115.597, 73.588, 20.803, 2.024, 3.467,
#'           21.39, 71.244, 117.758, 76.268, 22.224, 2.249)
#'
#' # Vector of survival rates for males
#' sr_m <- c(0.95557549, 0.9921273, 0.99594764, 0.99510483, 0.99178483,
#'           0.99134461, 0.99100899, 0.98929784, 0.98473229, 0.97588706,
#'           0.96048519, 0.93812765, 0.90615821, 0.8622277, 0.8047363,
#'           0.71333856, 0.596832, 0.44396816, 0.30330032, 0.18642771,
#'           0.0911662462413327, 0.96275471, 0.99399428, 0.9968488, 0.99563281,
#'           0.99229006, 0.99196446, 0.99180061, 0.99013625, 0.98594365,
#'           0.97719516, 0.96239426, 0.93950426, 0.90620399, 0.86117682,
#'           0.80225284, 0.71307413, 0.60022645, 0.4558758, 0.31005161,
#'           0.18518342, 0.0956313878791117, 0.96951141, 0.99496609, 0.99727649,
#'           0.99607245, 0.99233725, 0.99205108, 0.99228027, 0.99056435,
#'           0.98605767, 0.97783685, 0.96314897, 0.9406932, 0.90642888,
#'           0.86286999, 0.80387894, 0.71498269, 0.6066814, 0.46479967,
#'           0.31958557, 0.19836001, 0.101989015830425, 0.97545992, 0.99563858,
#'           0.99741385, 0.99592654, 0.99152023, 0.99192115, 0.9924163,
#'           0.990644, 0.98617665, 0.97752991, 0.96353815, 0.94114166,
#'           0.90833701, 0.86170391, 0.80301014, 0.72151551, 0.6128495,
#'           0.47608317, 0.32653048, 0.19655555, 0.103730263806538, 0.98060776,
#'           0.99617149, 0.99761403, 0.99542383, 0.99054495, 0.99194397,
#'           0.99266261, 0.99089428, 0.98611279, 0.97789594, 0.96434779,
#'           0.94341044, 0.91191009, 0.86748795, 0.80686197, 0.72532159,
#'           0.61846149, 0.48319275, 0.33857582, 0.2104904, 0.112385162790671,
#'           0.98550309, 0.99688352, 0.99803301, 0.9959062,
#'           0.99126003, 0.99231634, 0.99301369, 0.99160392, 0.98761021,
#'           0.97986329, 0.96646197, 0.94623899, 0.91718051, 0.87584219,
#'           0.81662218, 0.73700918, 0.6303803, 0.50160307, 0.3651526,
#'           0.23288489, 0.130850768617506, 0.98931819, 0.99775357, 0.9984583,
#'           0.99673481, 0.99301824, 0.99346278, 0.99369545, 0.99294003,
#'           0.98994327, 0.98356936, 0.97206458, 0.95389895, 0.92644026,
#'           0.88661213, 0.82907732, 0.74960973, 0.64331764, 0.51551648,
#'           0.37629084, 0.24487989, 0.137677217644374, 0.99112504, 0.99814201,
#'           0.99879926, 0.99711429, 0.99389061, 0.99409107, 0.99396033,
#'           0.99290953, 0.99073493, 0.98586868, 0.97625645, 0.95984456,
#'           0.93401387, 0.89576747, 0.84146086, 0.76230416, 0.6528808,
#'           0.51875327, 0.37059318, 0.23716232, 0.129879589178461, 0.99268153,
#'           0.99853182, 0.99902021, 0.99755244, 0.99471893, 0.99453053,
#'           0.99383731, 0.99242559, 0.99039498, 0.98664094, 0.97888902,
#'           0.96514568, 0.94232807, 0.90695918, 0.85686765, 0.78068285,
#'           0.6693777, 0.52625072, 0.37539746, 0.23620331, 0.123653858706926,
#'           0.99378702, 0.99880557, 0.99916867, 0.99795758, 0.99537754,
#'           0.99534488, 0.99484455, 0.99357678, 0.99141921, 0.9878473,
#'           0.98134482, 0.96932265, 0.94941573, 0.91742454, 0.86776992,
#'           0.79533967, 0.68311452, 0.5343893, 0.37262307, 0.2239178,
#'           0.113720633638293, 0.99399248, 0.99897976, 0.99932852, 0.99822431,
#'           0.99601855, 0.99591387, 0.99569633, 0.99470259, 0.99268715,
#'           0.98892298, 0.98249955, 0.97238094, 0.9552462, 0.92844911,
#'           0.88653064, 0.82114141, 0.71875477, 0.56869525, 0.39721252,
#'           0.23529357, 0.113792166251756, 0.99425766, 0.99909623, 0.99940998,
#'           0.99846006, 0.99631257, 0.99603178, 0.99592291, 0.99518752,
#'           0.99322132, 0.98983274, 0.98368064, 0.9741733, 0.9602258,
#'           0.93745239, 0.9016288, 0.8444638, 0.75222073, 0.60907965,
#'           0.4240168, 0.24939352, 0.117336219766853, 0.99471736, 0.99933256,
#'           0.99947765, 0.99871556, 0.99694493, 0.99649396, 0.99655801,
#'           0.99589338, 0.99413263, 0.99084735, 0.98542046, 0.97725847,
#'           0.96497949, 0.9452114, 0.9134356, 0.8610204, 0.7737601, 0.63147622,
#'           0.43996206, 0.25585397, 0.117677375365884, 0.99489165, 0.99937715,
#'           0.99951763, 0.99880472, 0.99710652, 0.99665932, 0.99675852,
#'           0.99614922, 0.99444005, 0.99122406, 0.98598437, 0.97827319,
#'           0.96683874, 0.94835124, 0.91833471, 0.86821514, 0.78398104,
#'           0.64282533, 0.44786339, 0.25892654, 0.117310656081295, 0.99547488,
#'           0.99923281, 0.99957341, 0.99911343, 0.99802214, 0.99709297,
#'           0.99680896, 0.99635099, 0.99498899, 0.99222347, 0.9875931,
#'           0.98060053, 0.97014661, 0.9536392, 0.92634894, 0.87987019,
#'           0.79856151, 0.66278044, 0.47312791, 0.2694788, 0.111570323438865,
#'           0.99610316, 0.99933917, 0.9996362, 0.99923203, 0.99825186,
#'           0.99737383, 0.99710434, 0.99670571, 0.99548655, 0.99299216,
#'           0.9888173, 0.98253469, 0.97316181, 0.95828527, 0.93341992,
#'           0.89062075, 0.81386423, 0.68145805, 0.49006978, 0.27830681,
#'           0.113218864970809, 0.99653042, 0.99941146, 0.99967816, 0.99931356,
#'           0.99841616, 0.99758578, 0.9973301, 0.99697294, 0.99585907,
#'           0.99356834, 0.9897352, 0.98398011, 0.97540572, 0.96174959,
#'           0.93872789, 0.89876001, 0.8256409, 0.69618678, 0.50377247,
#'           0.28557404, 0.114591438080939, 0.99688677, 0.99947174, 0.99971275,
#'           0.99938206, 0.99855794, 0.99777511, 0.99753337, 0.99721139,
#'           0.99619015, 0.99408084, 0.99055187, 0.98526355, 0.97739317,
#'           0.9648224, 0.94346085, 0.90607063, 0.83636949, 0.70989474,
#'           0.51681708, 0.29260349, 0.115932510195963, 0.99718332, 0.99952193,
#'           0.9997412, 0.99943948, 0.99868001, 0.99794372, 0.99771578,
#'           0.99742349, 0.99648352, 0.99453532, 0.99127626, 0.98639967,
#'           0.97914803, 0.96753912, 0.94766613, 0.91261037, 0.84609618,
#'           0.7225789, 0.52915469, 0.29935668, 0.117233382382913, 0.99743526,
#'           0.99956461, 0.99976514, 0.9994886, 0.99878699, 0.99809597,
#'           0.99788161, 0.99761483, 0.99674727, 0.99494418, 0.99192807,
#'           0.98742013, 0.98072071, 0.96997658, 0.95145635, 0.91854221,
#'           0.85503156, 0.73446104, 0.54096047, 0.30591861,
#'           0.118509238191645)
#'
#' # Vector of survival rates for females
#' sr_f <- c(0.854489854276296, 0.935421167801612, 0.97813792986728,
#'           0.982021189677661, 0.976828336081795, 0.97244561985297,
#'           0.968812772150047, 0.96483427499772, 0.96010802339363,
#'           0.954056165687121, 0.943306039954761, 0.92448836548943,
#'           0.890690237758345, 0.835639114030282, 0.754796751406155,
#'           0.644175707707241, 0.510754359186887, 0.367690608641792,
#'           0.24038748937665, 0.145450728453873, 0.0826258994519641,
#'           0.872081445760557, 0.944846444000478, 0.981301676540409,
#'           0.98454923599414, 0.980025670920247, 0.976133157582757,
#'           0.972813894527646, 0.968976434023376, 0.964396307993652,
#'           0.958650557701456, 0.948256461919103, 0.930336619590153,
#'           0.898721683064412, 0.846943744756808, 0.7693050373115,
#'           0.660761281137989, 0.526356065457763, 0.380513624627523,
#'           0.249631099810745, 0.150641910916079, 0.0845984581684562,
#'           0.886848633625797, 0.952485090106336, 0.983750072193038,
#'           0.986500893000163, 0.982460467395807, 0.978978117640805,
#'           0.975938233552867, 0.972378413253193, 0.967941794833695,
#'           0.962223931611845, 0.952268831689409, 0.935291261627555,
#'           0.905449822961756, 0.856292233575997, 0.781888442354377,
#'           0.676068647825169, 0.542224475987347, 0.394762631381521,
#'           0.260252774164775, 0.156857215747202, 0.0874135544568921,
#'           0.900784558263659, 0.9596839642243, 0.986196123803518,
#'           0.988385232322206, 0.984769248387878, 0.981657532920333,
#'           0.978917213857464, 0.975642526638743, 0.971423457946261,
#'           0.965729507599766, 0.956020853088256, 0.939966236835617,
#'           0.912171280137383, 0.865872642393594, 0.794508147678775,
#'           0.691547047753295, 0.558414706244368, 0.408689574652693,
#'           0.269878505194327, 0.1624396495176, 0.0898671492416105,
#'           0.912633835108388, 0.965550681132028, 0.987920059015778,
#'           0.989848240747598, 0.986695608763104, 0.983981235542121,
#'           0.981570190639542, 0.97861812228183, 0.974635289736998,
#'           0.9691431860219, 0.959749667932423, 0.944374872196883,
#'           0.918112298204692, 0.874309263183862, 0.80582736469469,
#'           0.705435057343639, 0.573891155573389, 0.423123546270893,
#'           0.280818298136084, 0.169320472983824, 0.0930347806338448,
#'           0.922791200429312, 0.970414095250172, 0.989432301168788,
#'           0.990708732285749, 0.987862933459543, 0.98554556950358,
#'           0.983439950663867, 0.980726138018158, 0.976956585172812,
#'           0.971679032024458, 0.962795297767379, 0.948303265698793,
#'           0.923561621562827, 0.882274284142424, 0.817184362828982,
#'           0.720298723984997, 0.590336398050365, 0.439061608307152,
#'           0.293893306863672, 0.178752339638971, 0.0979770657163587,
#'           0.933750711567667, 0.975650023350237, 0.991430129981753,
#'           0.99247477931302, 0.989942622594004, 0.987846767986695,
#'           0.98591292962169, 0.983362542545618, 0.979767042495056,
#'           0.974726611965329, 0.96628359885727, 0.95251185213316,
#'           0.929005505885616, 0.889790085932051, 0.827762556372604,
#'           0.734212960407364, 0.606322257595734, 0.453895037584414,
#'           0.305625301261282, 0.186403154530675, 0.101364444633525,
#'           0.942022185331379, 0.979147123918558, 0.992515619501369,
#'           0.9933310350342, 0.990999245807151, 0.98905130373017,
#'           0.987257739978207, 0.984897031588263, 0.981492787306857,
#'           0.9766673141557, 0.968686240948038, 0.955634366723833,
#'           0.9333801029294, 0.895907358522987, 0.836661271636903,
#'           0.746801163214231, 0.621415950298903, 0.468910608066693,
#'           0.317915153427838, 0.195039481469627, 0.105384282613558,
#'           0.94718229582512, 0.980790142908247, 0.992803300931434,
#'           0.993541163348349, 0.991307476656705, 0.989225443921528,
#'           0.987176469101693, 0.98460623719428, 0.981246509709472,
#'           0.976718447241337, 0.969160984177711, 0.956833654346736,
#'           0.935783935128507, 0.900223655022325, 0.843512027545961,
#'           0.75698552882669, 0.634658767009268, 0.482935300037292,
#'           0.329848456620383, 0.20331169504299, 0.10978246168398,
#'           0.953756599857967, 0.984059901645376, 0.993955214747401,
#'           0.994268297381336, 0.991878910452198, 0.989316711233698,
#'           0.98661050317541, 0.983509725457937, 0.980068840413112,
#'           0.975865841537748, 0.96873162752321, 0.957191306973029,
#'           0.937336013374256, 0.903694171906013, 0.84952642553648,
#'           0.76536853834578, 0.645403389194791, 0.494479119379901,
#'           0.339863899010747, 0.210826549541289, 0.113471459046826,
#'           0.960713535654886, 0.987033073900882, 0.994716009106623,
#'           0.994894234746082, 0.992525302465177, 0.9895538842758,
#'           0.986152805334012, 0.982472321949589, 0.979073662581534,
#'           0.975395328209274, 0.968932259296626, 0.958359612326248,
#'           0.939967835580358, 0.908680780255339, 0.857541392392623,
#'           0.777353828146545, 0.661131513296524, 0.512711981039796,
#'           0.357346432815676, 0.224662101978509, 0.121638559000661,
#'           0.967668081909087, 0.990008068984907, 0.995560889886471,
#'           0.995641991716643, 0.993624470509278, 0.991059373658537,
#'           0.988040353436121, 0.984673329703723, 0.981470430737054,
#'           0.977934939728761, 0.971766487949973, 0.961780792273926,
#'           0.944588362056491, 0.915303175185752, 0.867175365253056,
#'           0.790635307536064, 0.677656963580601, 0.530729783448463,
#'           0.374404597176352, 0.237203123872316, 0.127388492872508,
#'           0.973550993968318, 0.99237559671888, 0.996334437474569,
#'           0.996302569319733, 0.994665042785698, 0.992854350176394,
#'           0.990804628097226, 0.988299827070781, 0.985427217612243,
#'           0.98180549401774, 0.975726794918091, 0.966103852460658,
#'           0.949838547130851, 0.92234926803937, 0.877071883537886,
#'           0.804140728455995, 0.694271895287286, 0.548487335263838,
#'           0.389191763586342, 0.24733085854494, 0.131770634512774,
#'           0.977644495019607, 0.993809059507753, 0.996921848401461,
#'           0.996813848508293, 0.995383460235151, 0.993952685083984,
#'           0.992408034278954, 0.990393195059418, 0.987756840918104,
#'           0.984187864274535, 0.978346485320431, 0.969132680765175,
#'           0.953701455005333, 0.92763044136048, 0.884677298385547,
#'           0.814988789377917, 0.708878868603095, 0.565946568832964,
#'           0.40677396957209, 0.26150417331884, 0.138468877454496, 0.99589669,
#'           0.99939439, 0.99968965, 0.99946356, 0.99900599, 0.99861604,
#'           0.99832041, 0.99779148, 0.99668581, 0.9946399, 0.9913872,
#'           0.98672374, 0.97979077, 0.96855904, 0.94971941, 0.9172498,
#'           0.85796829, 0.74889563, 0.57422822, 0.35395265, 0.158786622360056,
#'           0.9963443, 0.99946056, 0.99972569, 0.99951979, 0.99909662,
#'           0.99871978, 0.99844108, 0.9979583, 0.99694158, 0.99505178,
#'           0.99204825, 0.98775485, 0.98138426, 0.97102475, 0.95351064,
#'           0.92310744, 0.86661424, 0.76030246, 0.58585433, 0.36085561,
#'           0.160294341407215, 0.99679414, 0.99952694, 0.99976136, 0.99957681,
#'           0.99919131, 0.99883301, 0.99857404, 0.99814009, 0.99721897,
#'           0.99549888, 0.99276597, 0.98887133, 0.98310375, 0.97368874,
#'           0.95762803, 0.92951136, 0.87619312, 0.77320377,
#'           0.59930763, 0.36898278, 0.162083812814283, 0.9971375, 0.99957757,
#'           0.99978821, 0.99962071, 0.99926645, 0.99892672, 0.99868509,
#'           0.9982903, 0.99744714, 0.99586696, 0.99335694, 0.98978824,
#'           0.98451115, 0.97587178, 0.96101941, 0.93482131, 0.88424374,
#'           0.78427805, 0.61113191, 0.37625625, 0.163698785477625, 0.99744017,
#'           0.99962217, 0.9998116, 0.99965971, 0.99933486, 0.99901498,
#'           0.99879044, 0.99843159, 0.99766096, 0.99621214, 0.99391125,
#'           0.99064648, 0.985825, 0.97791169, 0.9642029, 0.93983665,
#'           0.89194494, 0.79508552, 0.62293587, 0.38364594, 0.165352911452495,
#'           0.99771115, 0.99966211, 0.99983233, 0.99969485, 0.99939794,
#'           0.99909887, 0.9988912, 0.99856572, 0.9978633, 0.996539, 0.9944362,
#'           0.99145779, 0.98706409, 0.97983722, 0.96722115, 0.94462117,
#'           0.89938678, 0.80574358, 0.63485152, 0.39124343, 0.167067858821075)
#'
#'
#' all_years <- c("1950", "1955", "1960", "1965", "1970", "1975",
#'                "1980", "1985", "1990", "1995", "2000", "2005",
#'                "2010", "2015", "2020", "2025", "2030", "2035",
#'                "2040", "2045", "2050")
#'
#' # Population for males as matrix
#' pop_m_mat <- matrix(pop_m, nrow = 21, ncol = 21)
#' colnames(pop_m_mat) <- all_years
#'
#' # Population for females as matrix
#' pop_f_mat <- matrix(pop_f, nrow = 21, ncol = 21)
#' colnames(pop_f_mat) <- all_years
#'
#' # Age-specific-fertility-rate for as matrix
#' asfr_mat <- matrix(asfr, nrow = 7, ncol = 20)
#' colnames(asfr_mat) <- all_years[-length(all_years)]
#'
#' # Sex ratio at birth as vector
#' srb_vec <- c(1.058, 1.057, 1.055, 1.055, 1.06, 1.056, 1.056, 1.052, 1.056,
#'              1.054, 1.054, 1.053, 1.054, 1.053, 1.056, 1.056, 1.056, 1.056,
#'              1.056, 1.056)
#'
#' names(srb_vec) <- all_years[-length(all_years)]
#'
#' # Survival ratio for males as matrix
#' sr_m_mat <- matrix(sr_m, nrow = 21, ncol = 20)
#' colnames(sr_m_mat) <- all_years[-length(all_years)]
#'
#' # Survival ratio for females as matrix
#' sr_f_mat <- matrix(sr_f, nrow = 21, ncol = 20)
#' colnames(sr_f_mat) <- all_years[-length(all_years)]
#'
#' # Age/year sequence of all the data from above
#' interval <- 5
#' ages <- seq(0, 100, by = interval)
#' years <- seq(1950, 2050, by = interval)
#' ages_fertility     <- seq(15, 45, by = interval)
#' rownames(asfr_mat) <- ages_fertility
#' rownames(pop_m_mat) <- ages
#' rownames(pop_f_mat) <- ages
#' rownames(sr_m_mat) <- ages
#' rownames(sr_f_mat) <- ages
# mig_res <-
#  mig_resid_stock(
#    pop_m_mat = pop_m_mat,
#     pop_f_mat = pop_f_mat,
#    sr_m_mat = sr_m_mat,
#    sr_f_mat = sr_f_mat,
#    asfr_mat = asfr_mat,
#    srb_vec = srb_vec,
#     ages = ages,
#    ages_fertility = ages_fertility
#  )
#'
#' # Net migration for males using stock change method
#' mig_res$mig_m
#'
#' # Net migration for females using stock change method
#' mig_res$mig_f
#'
#'
#' ################ cohort even flow method  #####################
#'
#' # We reuse the same data from before
#'
#' mig_res <-
#'   mig_resid_cohort(
#'     pop_m_mat = pop_m_mat,
#'     pop_f_mat = pop_f_mat,
#'     sr_m_mat = sr_m_mat,
#'     sr_f_mat = sr_f_mat,
#'     asfr_mat = asfr_mat,
#'     srb_vec = srb_vec,
#'     ages = ages,
#'     ages_fertility = ages_fertility
#'   )
#'
#' # Net migration for males using the cohort even flow method
#' mig_res$mig_m
#'
#' # Net migration for females using the cohort even flow method
#' mig_res$mig_f
#'
#' ################ time even flow method  #####################
#'
#' # We reuse the same data from before
#'
#' mig_res <-
#'   mig_resid_time(
#'     pop_m_mat = pop_m_mat,
#'     pop_f_mat = pop_f_mat,
#'     sr_m_mat = sr_m_mat,
#'     sr_f_mat = sr_f_mat,
#'     asfr_mat = asfr_mat,
#'     srb_vec = srb_vec,
#'     ages = ages,
#'     ages_fertility = ages_fertility
#'   )
#'
#' # Net migration for males using the time even flow method
#' mig_res$mig_m
#'
#' # Net migration for females using the time even flow method
#' mig_res$mig_f
#'
#' @export
mig_resid_stock <- function(pop_m_mat,
                            pop_f_mat,
                            sr_m_mat,
                            sr_f_mat,
                            asfr_mat,
                            srb_vec,
                            ages = NULL,
                            ages_fertility = NULL,
                            years_pop = NULL,
                            years_sr = NULL,
                            years_asfr = NULL,
                            years_srb = NULL) {
  # this arg list can feed into the checker
  args_list <- as.list(match.call())

  mig_resid_dim_checker(args_list)
  
  pop_m_mat <- args_list$pop_m_mat
  pop_f_mat <- args_list$pop_f_mat
  sr_m_mat  <- args_list$sr_m_mat
  sr_f_mat  <- args_list$sr_f_mat
  asfr_mat  <- args_list$asfr_mat
  srb_vec   <- args_list$srb_vec



  stopifnot(
    is.matrix(pop_m_mat),
    is.matrix(pop_f_mat),
    is.matrix(sr_m_mat),
    is.matrix(sr_f_mat),
    is.matrix(asfr_mat),
    is.numeric(srb_vec),
    is.numeric(ages),
    is.numeric(ages_fertility)
  )

  

# <<<<<<< HEAD
#   # Check in dimensions are ok - still working on this
#   if(ncol(asfr_mat) == ncol(pop_f_mat) -1 & nrow(sr_f_mat) == nrow(pop_f_mat) -1){
#     print("matrix dimensions are correct")
#   }
#     else {
#     print("check matrix dimensions")
#   }
#   
#   #if there are extra years, drop it - still thinking the best way to deal with it
#   if(ncols(asfr_mat) != ncols(sr_f_mat)){
#     asfr_mat <- asfr_mat[, colnames(sr_f_mat)]
#     sr_f_mat <- sr_f_mat[, colnames(asfr_mat)]
#   }
#   else {
#     asfr_mat
#     sr_f_mat
#   }
# =======
# >>>>>>> 362ae9857574b05c519c8de40548461d6b9070dd



  # Migration net of only survivors
  net_mig_m <- migresid_net_surv(pop_m_mat, sr_m_mat)
  net_mig_f <- migresid_net_surv(pop_f_mat, sr_f_mat)

 # fertility_index <- which(ages %in% ages_fertility)

  # Returns all births for all years
  age_interval <- unique(diff(ages))
  all_births <- migresid_births(
    pop_f_mat,
    asfr_mat,
   # fertility_index,
    age_interval
  )

  # With all_births already calculated, separate between
  # female/male births with the sex ratio at birth
  byrs     <- names(all_births)
  births_m <- all_births * (srb_vec[byrs] / (1 + srb_vec[byrs]))
  births_f <- all_births * (1 / (1 + srb_vec[byrs]))

  net_mig_m <- migresid_net_surv_first_ageg(
    net_mig_m,
    pop_m_mat,
    births_m,
    sr_m_mat
  )

  net_mig_f <- migresid_net_surv_first_ageg(
    net_mig_f,
    pop_f_mat,
    births_f,
    sr_f_mat
  )

  # First year is empty, so we exclude
  list(
    mig_m = net_mig_m,
    mig_f = net_mig_f
  )
}

#' @rdname mig_resid_stock
#' @export
mig_resid_cohort <- function(pop_m_mat,
                             pop_f_mat,
                             sr_m_mat,
                             sr_f_mat,
                             asfr_mat,
                             srb_vec,
                             ages = NULL,
                             ages_fertility = NULL,
                             years_pop = NULL,
                             years_sr = NULL,
                             years_asfr = NULL,
                             years_srb = NULL) {
  # this arg list can feed into the checker
  args_list <- as.list(match.call())
  
  mig_resid_dim_checker(args_list)
  
  pop_m_mat <- args_list$pop_m_mat
  pop_f_mat <- args_list$pop_f_mat
  sr_m_mat  <- args_list$sr_m_mat
  sr_f_mat  <- args_list$sr_f_mat
  asfr_mat  <- args_list$asfr_mat
  srb_vec   <- args_list$srb_vec

  # Estimate stock method
  mig_res <-
    mig_resid_stock(
      pop_m_mat = pop_m_mat,
      pop_f_mat = pop_f_mat,
      sr_m_mat = sr_m_mat,
      sr_f_mat = sr_f_mat,
      asfr_mat = asfr_mat,
      srb_vec = srb_vec,
      ages = ages,
      ages_fertility = ages_fertility
    )

  net_mig_m <- mig_res$mig_m
  net_mig_f <- mig_res$mig_f

  # Estimate bounds for males
  mig_m_bounds <- migresid_bounds(net_mig_m, sr_m_mat)
  mig_upper_m <- mig_m_bounds$upper
  mig_lower_m <- mig_m_bounds$lower

  # Estimate bounds for females
  mig_f_bounds <- migresid_bounds(net_mig_f, sr_f_mat)
  mig_upper_f <- mig_f_bounds$upper
  mig_lower_f <- mig_f_bounds$lower

  # Adjust last age group in the bounds
  mig_bounds <- migresid_bounds_last_ageg(
    net_mig_m,
    net_mig_f,
    mig_upper_m,
    mig_lower_m,
    mig_upper_f,
    mig_lower_f
  )

  mig_upper_m <- mig_bounds$mig_upper_m
  mig_lower_m <- mig_bounds$mig_lower_m
  mig_upper_f <- mig_bounds$mig_upper_f
  mig_lower_f <- mig_bounds$mig_lower_f

  # Combine both upper/lower bound into a single rectangle
  mig_rectangle_m <- mig_upper_m + mig_lower_m
  mig_rectangle_f <- mig_upper_f + mig_lower_f

 list(
   mig_m = mig_rectangle_m[, -1],
   mig_f = mig_rectangle_f[, -1]
 )
 # TR: we prefer this, but somewhere earlier in processing
 # we get an extra column 1 full of NAs. So let's just not let that happen
  # list(
  #   mig_m = mig_rectangle_m,
  #   mig_f = mig_rectangle_f
  # )
}

#' @rdname mig_resid_stock
#' @export
mig_resid_time <- function(pop_m_mat,
                           pop_f_mat,
                           sr_m_mat,
                           sr_f_mat,
                           asfr_mat,
                           srb_vec,
                           ages = NULL,
                           ages_fertility = NULL,
                           years_pop = NULL,
                           years_sr = NULL,
                           years_asfr = NULL,
                           years_srb = NULL) {
  # this arg list can feed into the checker
  args_list <- as.list(match.call())
  
  mig_resid_dim_checker(args_list)
  
  pop_m_mat <- args_list$pop_m_mat
  pop_f_mat <- args_list$pop_f_mat
  sr_m_mat  <- args_list$sr_m_mat
  sr_f_mat  <- args_list$sr_f_mat
  asfr_mat  <- args_list$asfr_mat
  srb_vec   <- args_list$srb_vec

  # TR: add chunk (maybe a new function?) that
  # checks dimensions; names dimensions if necessary (and warns if so)
  # and trims dimensions if necessary (warning user if needed).
  # warning does mean warning() it just means cat("\nwatch out!\n")
  # Not important, but theese could be silenced using a new 'verbose' arg
  
  
  # Estimate stock method
  mig_res <-
    mig_resid_stock(
      pop_m_mat = pop_m_mat,
      pop_f_mat = pop_f_mat,
      sr_m_mat = sr_m_mat,
      sr_f_mat = sr_f_mat,
      asfr_mat = asfr_mat,
      srb_vec = srb_vec,
      ages = ages,
      ages_fertility = ages_fertility
    )

  # Separate male/female net migration
  net_mig_m <- mig_res$mig_m
  net_mig_f <- mig_res$mig_f

  # Adjust age group 0-4
  net_mig_m[1, ] <- 2 * net_mig_m[1, ]
  net_mig_f[1, ] <- 2 * net_mig_f[1, ]

  # Adjust age groups 5-10  to 100+ (of whatever maximum age groups)
  for (i in 2:nrow(net_mig_m)) {
    double_pop_m <- (2 * net_mig_m[i, ])
    double_pop_f <- (2 * net_mig_f[i, ])

    # Multiply net mig of i - 1 by survival rate of i
    # to get number of survived
    mig_sr_m <- net_mig_m[i - 1, ] * sr_m_mat[i, ]
    mig_sr_f <- net_mig_f[i - 1, ] * sr_f_mat[i, ]

    net_mig_m[i, ] <- double_pop_m - mig_sr_m
    net_mig_f[i, ] <- double_pop_f - mig_sr_f
  }

  list(
    mig_m = net_mig_m,
    mig_f = net_mig_f
  )
}


# Net migration is pop minus the people that survived from the previous
# age/cohort
migresid_net_surv <- function(pop_mat, sr_mat) {
  n                <- nrow(pop_mat)
  p                <- ncol(pop_mat)
  survived         <- pop_mat[-n, -p] * sr_mat[-1, ]
  res              <- pop_mat[-1, -1] - survived
  res[nrow(res), ] <- NA
  res              <- rbind(matrix(NA, nrow = 1, ncol = ncol(res)), res)
  #res              <- cbind(matrix(NA, nrow = nrow(res), ncol = 1), res)
  res              <- migresid_net_surv_last_ageg(res, pop_mat, sr_mat)
  rownames(res)    <- rownames(pop_mat)
  colnames(res)    <- colnames(pop_mat)[-p]
  res
}

# Net migration for last age group is pop for that age group in
# year j, minus the people from the previous age group the survived
migresid_net_surv_last_ageg <- function(net_mig, pop_mat, sr_mat) {
  # TR: this uses position indexing.
  n <- nrow(pop_mat)
  p <- ncol(pop_mat)
  previous_year <- 1:(p - 1)
  survived <-
    (pop_mat[n, previous_year] + pop_mat[n - 1, previous_year]) *
    sr_mat[n, previous_year]

  net_mig[nrow(net_mig), ] <- pop_mat[n, 2:p] - survived
  net_mig
}

migresid_births <- function(pop_f_mat,
                            asfr_mat,
                            #fertility_index,
                            age_interval) {
  p         <- ncol(pop_f_mat)
  asfr_ages <- rownames(asfr_mat)
  # Sum female pop from previous year and this year
  # f_pop <- pop_f_mat[asfr_ages, -1] + pop_f_mat[asfr_ages, -p]
  yrs     <- colnames(pop_f_mat) %>% as.numeric()
  yrs_out <- yrs[-p] + diff(yrs) / 2
  f_expos <-  interp(
                pop_f_mat[asfr_ages, ], 
                datesIn = yrs, 
                datesOut = yrs_out, 
                method = "linear")
  asfr_years  <- yrs[-p] %>% as.character()
  # Births that occurred for all age groups for all years
  # based on the age-specific fertility rate (asfr) from
  # previous years to the population
  these_births <- age_interval * (f_expos * asfr_mat[ , asfr_years]) # / 1000
  these_births <- colSums(these_births)
  names(these_births) <- asfr_years
  # all_births <- c(NA, colSums(these_births))
  # col_names  <- attr(pop_f_mat, "dimnames")[[2]]
  # all_births <- stats::setNames(all_births, col_names)
  # all_births
  these_births
}

migresid_net_surv_first_ageg <- function(net_mig, pop_mat, births, sr_mat) {
  # 20 yrs of births
  # 21 yrs of population
  # 20 yrs of sr
  p    <- ncol(net_mig)
  pyrs <- colnames(pop_mat)[-1] 
  
  # TR: a little hack
  D    <- pyrs %>% as.numeric() %>% diff() %>% '['(1)
  byrs <- pyrs %>% as.numeric() %>% '-'(D ) %>% as.character()
  # TR: note net_mig col labels seem to be one too high
  # we want byrs indexing on the left
  net_mig[1, ] <- pop_mat[1, pyrs] - births[byrs] * sr_mat[1, byrs]
  net_mig
}


# Returns age/year matrices with upper/lower bounds
# for net migration based on the net migration and
# survival rates. These, I believe are the upper/lower
# bounds of a lexis surfave (which is why we do ^0.5).
migresid_bounds <- function(net_mig, sr_mat) {
  n <- nrow(net_mig)
  p <- ncol(net_mig)

  # Upper bound is net mig / 2 times the survival ratio ^ 0.5
  mig_upper      <- net_mig / (2 * sr_mat^0.5)
  mig_upper      <- cbind(matrix(NA, ncol = 1, nrow = n), mig_upper)
  mig_lower      <- mig_upper
  mig_upper[1, ] <- NA
  mig_upper[n, ] <- NA
  mig_lower[n, ] <- NA
  mig_lower      <- mig_lower[-1, ]
  empty_matrix   <- matrix(NA, ncol = ncol(mig_lower), nrow = 1)
  mig_lower      <- rbind(mig_lower, empty_matrix)

  # Estimate upper bounds for the first age group. Why
  # no lower bound for the first age group? because we have
  # no previous age group.
  p_upper        <- ncol(mig_upper)
  mig_upper[1, 2:p_upper] <- net_mig[1, -p_upper] / (sr_mat[1, -p_upper]^0.5)

  list(upper = mig_upper, lower = mig_lower)
}

# Updates last age group for all upper/lower bounds
migresid_bounds_last_ageg <- function(net_mig_m,
                                      net_mig_f,
                                      mig_upper_m,
                                      mig_lower_m,
                                      mig_upper_f,
                                      mig_lower_f) {


  # last age group
  n <- nrow(mig_upper_m)
  p <- ncol(mig_upper_m)

  mig_lower_m[n - 1, ] <- mig_upper_m[n - 1, ]
  mig_lower_f[n - 1, ] <- mig_upper_f[n - 1, ]
  mig_upper_m[n, 2:p] <- net_mig_m[n, -p] * 0.5
  mig_upper_f[n, 2:p] <- net_mig_f[n, -p] * 0.5
  mig_lower_m[n, 2:p] <- net_mig_m[n, -p] * 0.5
  mig_lower_f[n, 2:p] <- net_mig_f[n, -p] * 0.5

  list(
    mig_lower_m = mig_lower_m,
    mig_upper_m = mig_upper_m,
    mig_lower_f = mig_lower_f,
    mig_upper_f = mig_upper_f
  )
}


mig_resid_dim_checker <- function(arg_list){

  # TR: objectives, either we get args from a properly captured arg_list,
  # or we simply pass in all args by name (maybe the easiest to be certain of)
  # ground rules:
  # age ranges should match for sr and pop. If they don't then we should trim to the
  # lowest common denominator, right?
  # year ranges depend on the input:
  # sr, asfr, srb need to have same years, but pop needs one extra year on the right side.
  
  # Each data argument should be given adequate dimnames for purposes of named selection
  # Each data argument should be trimmed as appropriate for conformable computations
  # If trimming happens, we warn if verbose.
  # This function basically just needs to return data inputs whose dimensions are
  # guaranteed to not cause problems in downstream mig_resid*() calcs.
  # the reason why we do this here is so that these many lines of code aren't repeated.
  
  pop_m_mat       <- arg_list$pop_m_mat
  pop_f_mat       <- arg_list$pop_f_mat
  sr_m_mat        <- arg_list$sr_m_mat
  sr_f_mat        <- arg_list$sr_f_mat
  asfr_mat        <- arg_list$asfr_mat
  srb_vec         <- arg_list$srb_vec
  ages            <- arg_list$ages
  ages_fertility  <- arg_list$ages_fertility
  
  # Make sure to add these year args to top level mig_resid* funcions.
  years_pop       <- arg_list$years_pop
  years_sr        <- arg_list$years_sr   
  years_asfr      <- arg_list$years_asfr
  years_srb       <- arg_list$years_srb
  
  # Make sure to add verbose arg to top level mig_resid*() functions.
  verbose         <- arg_list$verbose  
  # These are easier to insist on:
  stopifnot(all(dim(pop_m_mat) == dim(pop_f_mat)))
  stopifnot(all(dim(sr_m_mat) == dim(sr_f_mat)))
  
  # These args, could be NULL, so look to dimnames:
  if (is.null(ages)){
    ages             <- rownames(pop_m_mat) %>% as.numeric()
  }
  if (is.null(years_pop)){
    ages_fertility   <- rownames(asfr_mat) %>% as.numeric()
  }
  if (is.null(years_pop)){
    years_pop        <- colnames(pop_m_mat) %>% as.numeric()
  }
  if (is.null(years_asfr)){
    # TR: let's be careful that this doesn't end up hard coded at 15-45 or 15-49
    # when used throughout the functions. Hypothetically, it could have same ages
    # as pop or mort, but have 0s in non-fertile ages, make sense? This note
    # may be out of place, but came to mind here.
    years_asfr       <- colnames(asfr_mat) %>% as.numeric()
  }
  if (is.null(years_sr)){
    years_sr         <- colnames(sr_m_mat) %>% as.numeric()
  }
  if (is.null(years_srb)){
    years_srb        <- names(srb_vec) %>% as.numeric()
  }
 
  # Note, after the above, the years/ ages could still be NULL,
  # In this case we demand that dimensions already conform with expectations
  
  # For ages, we can guess from dims. For years, we can't guess from dims.
  # Therefore at least one of the year vectors needs to be non-NULL, AND
  # the dims of matrices to which NULL years correspond must already be correct.
  
  np    <- ncol(pop_f_mat)
  nsr   <- ncol(sr_m_mat)
  nfert <- ncol(asfr_mat)
  nsrb  <- length(srb_vec)
  
  dims_already_correct <- all(diff(c(np-1,nsr,nfert,nsrb) == 0))
  
  ind_nulls <- c(years_pop = is.null(years_pop), 
                 years_asfr = is.null(years_asfr), 
                 years_srb = is.null(years_srb), 
                 years_sr = is.null(years_sr))
  
  # it's easiest to just force users to give year ranges via args
  # or dimnames. If neither is available, just make them do it.
  if (any(ind_nulls)){
    stop("Year references must be given, either via function args or dimnames. Following references missing:\n",paste(names(ind_nulls)[ind_nulls],collapse=", "))
  }
  

  # 1) assign names
  colnames(pop_m_mat)    <- years_pop
  colnames(pop_f_mat)    <- years_pop
  colnames(asfr_mat)     <- years_fertility
  colnames(sr_m_mat)     <- years_sr
  colnames(sr_f_mat)     <- years_sr
  names(srb_vec)         <- years_srb
  
  # maybe there should be more thorough checks on age? 
  # we might be assigning NULL here...
  rownames(pop_m_mat)    <- ages
  rownames(pop_f_mat)    <- ages
  rownames(sr_m_mat)     <- ages
  rownames(sr_f_mat)     <- ages
  rownames(asfr_mat)     <- ages_fertility
  
  # 2) determine ranges
  # if dims aren't already correct
  yr1    <- max(c(min(years_pop),
                  min(years_sr),
                  min(years_asfr),
                  min(years_srb)))
  yrlast <- min(c(max(years_pop[-np]),
                  max(years_sr),
                  max(years_asfr),
                  max(years_srb)))
  
  interval      <- diff(years_asfr)[1] %>% as.integer()
  
  # just remember we need 1 more for pops!
  years_final   <- seq(yr1, yrlast, by = interval)
  years_final_p <- c(years_final, max(years_final) + interval)
  # trim
  pop_m_mat     <- pop_m_mat[, years_final_p ]
  
  if (ncol(pop_m_mat)!=np){
    # TR: should have one of these per trim step?
    if (verbose){
      cat("\npop_m_mat years have trimmed\n")
    }
  }
  
  pop_f_mat     <- pop_f_mat[, years_final_p ]
  sr_m_mat      <- sr_m_mat[, years_final ]
  sr_f_mat      <- sr_f_mat[, years_final ]
  asfr_mat      <- asfr_mat[, years_final ]
  srb_vec       <- srb_vec[ years_final ]
  
  out <- list(pop_m_mat = pop_m_mat,
              pop_f_mat = pop_f_mat,
              sr_m_mat = sr_m_mat,
              sr_f_mat = sr_f_mat,
              asfr_mat = asfr_mat,
              srb_vec = srb_vec)
  
  
}


# match.call.defaults <- function(...) {
#   call <- evalq(match.call(expand.dots = FALSE), parent.frame(1))
#   formals <- evalq(formals(), parent.frame(1))
#   
#   for(i in setdiff(names(formals), names(call)))
#     call[i] <- list( formals[[i]] )
#   
#   
#   match.call(sys.function(sys.parent()), call)
# }

# foo <- function(a,b=NULL,...){match.call.defaults()}
# foo(a=1,x=5)
# foo(a = 1, b = NULL, ... = pairlist(x = 5))